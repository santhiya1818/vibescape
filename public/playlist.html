<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Playlists | VibeScape</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="vibescapelogo.jpg" type="image/jpg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Your existing CSS is perfect, no changes are needed here */
    :root { --header-bg-color: #222; --footer-bg-color: #222; --text-color: #f1e6e6; }
    body.light-theme { --header-bg-color: #f5f5f5; --footer-bg-color: #f5f5f5; --text-color: #000000; --header-text-color: #000; --footer-text-color: #000; }
    .header, footer { background-color: var(--header-bg-color); color: var(--text-color); }
    footer { background-color: var(--footer-bg-color); color: var(--text-color); }
    /* Enhanced Playlist Styling */
    .main-content { 
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); 
        min-height: 100vh; 
        padding: 2rem 1rem; 
    }
    body.light-theme .main-content { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    }
    
    .playlist-container { 
        max-width: 1000px; 
        margin: 0 auto; 
        background: rgba(0,0,0,0.7); 
        border-radius: 20px; 
        padding: 2rem; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        backdrop-filter: blur(10px); 
        color: #fff;
    }
    body.light-theme .playlist-container { 
        background: rgba(255,255,255,0.1); 
        color: #fff; 
    }
    
    .playlist-btns { margin: 2rem 0 1rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 0.8rem; }
    .playlist-btn { 
        padding: 0.8rem 1.8rem; 
        font-size: 1rem; 
        border-radius: 25px; 
        border: 2px solid #e30088; 
        background: rgba(255,255,255,0.1); 
        color: #fff; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        font-weight: 600; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
    }
    .playlist-btn.active, .playlist-btn:hover { background: linear-gradient(45deg, #e30088, #ff1493); color: #fff; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(227,0,136,0.3); }
    .delete-playlist-btn { color: #e30088; background: none; border: none; font-size: 1.2rem; margin-left: 0.8rem; cursor: pointer; transition: all 0.3s ease; }
    .delete-playlist-btn:hover { color: #a0005a; transform: scale(1.2); }
    
    .playlist-songs { margin-top: 2rem; display: grid; gap: 0.8rem; max-height: 400px; overflow-y: auto; padding-right: 10px; }
    .playlist-songs::-webkit-scrollbar { width: 8px; }
    .playlist-songs::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .playlist-songs::-webkit-scrollbar-thumb { background: linear-gradient(45deg, #e30088, #ff1493); border-radius: 10px; }
    
    .song-card { 
        display: flex; 
        align-items: center; 
        background: rgba(255,255,255,0.1); 
        border-radius: 12px; 
        padding: 0.8rem 1rem; 
        border: 1px solid rgba(255,255,255,0.2); 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        transition: all 0.3s ease; 
        position: relative; 
        overflow: hidden; 
        color: #fff;
    }
    .song-card::before { 
        content: ''; 
        position: absolute; 
        left: 0; 
        top: 0; 
        height: 100%; 
        width: 4px; 
        background: linear-gradient(45deg, #e30088, #ff1493); 
    }
    .song-card:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 8px 25px rgba(227,0,136,0.3); 
        background: rgba(255,255,255,0.15); 
    }
    body.light-theme .song-card { 
        background: rgba(0,0,0,0.05); 
        border: 1px solid rgba(0,0,0,0.1); 
        color: #333; 
    }
    body.light-theme .song-card:hover { 
        background: rgba(0,0,0,0.1); 
    }
    body.light-theme .song-card span {
        color: #333 !important;
        font-weight: 500 !important;
    }
    body.light-theme .song-card i {
        color: #e30088 !important;
    }
    body.light-theme .song-card button {
        color: #e30088 !important;
    }
    body.light-theme .playlist-container { 
        background: rgba(255,255,255,0.9); 
        color: #333; 
    }
    body.light-theme .playlist-btn { 
        background: linear-gradient(45deg, #333, #555); 
        color: #fff; 
        border-color: #333;
    }
    body.light-theme .playlist-btn.active, body.light-theme .playlist-btn:hover { 
        background: linear-gradient(45deg, #e30088, #ff1493); 
        color: #fff; 
    }
    .delete-checkbox { margin-right: 1rem; accent-color: #e30088; width: 18px; height: 18px; cursor: pointer; }
    .delete-confirm-btn { margin-top: 2rem; background: linear-gradient(45deg, #e30088, #ff1493); color: #fff; border: none; border-radius: 25px; padding: 0.8rem 2rem; font-size: 1rem; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; }
    .delete-confirm-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(227,0,136,0.4); }
    
    .controls { margin: 2rem 0; display: flex; justify-content: center; gap: 1.5rem; align-items: center; }
    .controls button { background: linear-gradient(45deg, #e30088, #ff1493); color: #fff; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .controls button:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(227,0,136,0.4); }
    
    .sort-select { margin: 1rem 0; background: linear-gradient(45deg, #e30088, #ff1493); color: #fff; border: none; border-radius: 20px; padding: 0.8rem 1.5rem; font-size: 1rem; cursor: pointer; font-weight: 600; outline: none; }
    .sort-select option { background: #fff; color: #333; }
    
    .playing-title { font-weight: bold; color: #e30088; text-shadow: 0 2px 4px rgba(227,0,136,0.3); }
    body.light-theme .playing-title { color: #fff; text-shadow: 0 2px 4px rgba(255,255,255,0.5); }
    
    .progress-container { display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    body.light-theme .progress-container { background: rgba(255,255,255,0.2); }
    
    .progress-container input[type="range"] { flex: 1; appearance: none; height: 6px; background: linear-gradient(to right, #e30088, #ff1493); border-radius: 10px; outline: none; }
    .progress-container input[type="range"]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: #fff; border: 3px solid #e30088; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(227,0,136,0.3); }
    .progress-time { font-size: 0.95rem; color: #e30088; font-weight: 600; min-width: 45px; text-align: center; }
    body.light-theme .progress-time { color: #fff; }
    
    h1 { 
        text-align: center; 
        color: #fff; 
        font-size: 2.5rem; 
        margin-bottom: 1rem; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
    }
    body.light-theme h1 { 
        color: #fff; 
        text-shadow: 0 2px 4px rgba(255,255,255,0.3); 
    }
    
    .no-songs, .error { text-align: center; padding: 2rem; color: #666; font-style: italic; font-size: 1.1rem; }
    body.light-theme .no-songs, body.light-theme .error { color: #fff; }
    .theme-toggle { position: absolute; top: 50%; right: 90px; transform: translateY(-50%); width: 45px; height: 45px; border-radius: 50%; border: none; background-color: var(--header-bg-color); color: var(--text-color); font-size: 1.3rem; cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; }
    .profile { position: relative; display: inline-block; }
    .dropdown { display: none; position: absolute; top: 45px; right: 0; background: rgb(0, 0, 0); border: 1px solid #000000; border-radius: 5px; min-width: 150px; box-shadow: 0 4px 6px rgba(0,0,0,0.15); z-index: 999; }
    .dropdown a { display: block; padding: 10px; color: rgb(255, 255, 255); text-decoration: none; }
    .dropdown a:hover { background: #e005a2; }
    .dropdown.show { display: block; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="vibescapelogo.jpg" alt="VibeScape Logo" />
      <h2>VibeScape</h2>
    </div>
    <nav class="nav-links">
      <a href="home.html">Home</a>
      <a href="history.html">History</a>
      <a href="playlist.html">Playlist</a>
      <a href="favourites.html">Favourites</a>
      <a href="comments.html">Comments</a>
    </nav>
    <button id="theme-toggle" class="theme-toggle"><i class="fa-solid fa-sun"></i></button>
    <div class="profile" id="profile-menu">
      <img src="https://via.placeholder.com/40" alt="Profile" id="profile-img" />
      <div class="dropdown" id="profile-dropdown">
        <a href="settings.html">Settings</a>
        <a href="index.html">Logout</a>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="playlist-container">
      <h1><i class="fa-solid fa-music"></i> Your Playlists <i class="fa-solid fa-heart"></i></h1>
      <div class="playlist-btns" id="playlist-btns"></div>

      <select class="sort-select" id="sort-select">
        <option value="default">ðŸŽµ Sort: Default</option>
        <option value="asc">ðŸ“ˆ A â†’ Z</option>
        <option value="desc">ðŸ“‰ Z â†’ A</option>
      </select>

      <div class="playlist-songs" id="playlist-songs"></div>

      <div class="controls">
        <button id="prev-song" title="Previous Song"><i class="fa-solid fa-backward"></i></button>
        <button id="toggle-play" title="Play/Pause"><i class="fa-solid fa-play"></i></button>
        <button id="next-song" title="Next Song"><i class="fa-solid fa-forward"></i></button>
      </div>

      <div class="progress-container">
        <span class="progress-time" id="current-time">0:00</span>
        <input type="range" id="progress-bar" value="0" min="0" max="100">
        <span class="progress-time" id="total-time">0:00</span>
      </div>

      <button class="delete-confirm-btn" id="delete-confirm-btn">
        <i class="fa-solid fa-trash"></i> Delete Selected
      </button>
    </div>
  </main>

  <footer>
     <a href="support.html">Support</a>
     <a href="about.html">About</a>
     <a href="terms.html">Terms of Service</a>
     <a href="privacy.html">Privacy Policy</a>
  </footer>

  <audio id="audio-player" src=""></audio>

  <!-- *** SCRIPT SECTION HAS BEEN COMPLETELY REPLACED *** -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        let allSongs = []; // This will hold the entire song library from the server
        let playlists = JSON.parse(localStorage.getItem('playlists')) || {};
        let currentPlaylist = null;
        let currentPlaylistSongs = []; // The currently displayed (and possibly sorted) list
        let playingIndex = null;

        const playlistBtns = document.getElementById('playlist-btns');
        const playlistSongsDiv = document.getElementById('playlist-songs');
        const deleteBtn = document.getElementById('delete-confirm-btn');
        const audioPlayer = document.getElementById('audio-player');
        const sortSelect = document.getElementById('sort-select');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const togglePlayBtn = document.getElementById('toggle-play');
        const themeToggleBtn = document.getElementById('theme-toggle');

        // Fetch the complete song library from the server
        async function loadSongsFromServer() {
            try {
                const response = await fetch('/api/songs');
                if (!response.ok) throw new Error('Failed to fetch song library');
                allSongs = await response.json();
                console.log(`Successfully loaded ${allSongs.length} songs from the server.`);
            } catch (error) {
                console.error("Could not load song library:", error);
                playlistSongsDiv.innerHTML = '<div class="error">Could not load song library from server.</div>';
            }
        }

        function renderPlaylistButtons() {
            playlistBtns.innerHTML = '';
            const names = Object.keys(playlists);
            if (names.length === 0) {
                playlistBtns.innerHTML = '<p>No playlists yet. Add songs to playlists from the Home page.</p>';
                playlistSongsDiv.innerHTML = '';
                currentPlaylist = null;
                return;
            }

            // Set a default playlist if none is selected
            if (!currentPlaylist && names.length > 0) {
                currentPlaylist = names[0];
            }

            names.forEach(name => {
                const wrapper = document.createElement('div');
                const btn = document.createElement('button');
                btn.className = 'playlist-btn' + (name === currentPlaylist ? ' active' : '');
                btn.textContent = name;
                btn.onclick = () => {
                    currentPlaylist = name;
                    playingIndex = null;
                    audioPlayer.pause();
                    audioPlayer.src = '';
                    updateToggleIcon();
                    renderPlaylistButtons();
                    renderPlaylistSongs();
                };
                wrapper.appendChild(btn);

                const delBtn = document.createElement('button');
                delBtn.className = 'delete-playlist-btn';
                delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to delete the playlist "${name}"?`)) {
                        delete playlists[name];
                        localStorage.setItem('playlists', JSON.stringify(playlists));
                        if (currentPlaylist === name) currentPlaylist = null;
                        renderPlaylistButtons();
                        renderPlaylistSongs();
                    }
                };
                wrapper.appendChild(delBtn);
                playlistBtns.appendChild(wrapper);
            });
        }

        function renderPlaylistSongs() {
            playlistSongsDiv.innerHTML = '';
            if (!currentPlaylist || !playlists[currentPlaylist] || playlists[currentPlaylist].length === 0) {
                playlistSongsDiv.innerHTML = '<div class="no-songs">This playlist is empty.</div>';
                deleteBtn.style.display = 'none';
                currentPlaylistSongs = [];
                return;
            }

            let songTitles = [...playlists[currentPlaylist]];
            if (sortSelect.value === 'asc') songTitles.sort((a, b) => a.localeCompare(b));
            if (sortSelect.value === 'desc') songTitles.sort((a, b) => b.localeCompare(a));
            
            currentPlaylistSongs = songTitles; // Update the currently displayed song list

            songTitles.forEach((songTitle, idx) => {
                const card = document.createElement('div');
                card.className = 'song-card';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'delete-checkbox';
                checkbox.dataset.songTitle = songTitle; // Use title for deletion
                card.appendChild(checkbox);

                const songIcon = document.createElement('i');
                songIcon.className = 'fa-solid fa-music';
                songIcon.style.marginRight = '0.8rem';
                songIcon.style.color = '#e30088';
                songIcon.style.fontSize = '1.1rem';
                card.appendChild(songIcon);

                const titleSpan = document.createElement('span');
                titleSpan.textContent = songTitle;
                titleSpan.style.flex = "1";
                titleSpan.style.cursor = "pointer";
                titleSpan.style.fontSize = "0.95rem";
                titleSpan.style.fontWeight = "500";
                if (playingIndex === idx && !audioPlayer.paused) {
                    titleSpan.classList.add("playing-title");
                    songIcon.className = 'fa-solid fa-volume-high';
                    songIcon.style.color = '#e30088';
                }
                titleSpan.onclick = () => playSong(idx);
                card.appendChild(titleSpan);

                const playBtn = document.createElement('button');
                playBtn.innerHTML = playingIndex === idx && !audioPlayer.paused ? 
                    '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
                playBtn.style.background = 'none';
                playBtn.style.border = 'none';
                playBtn.style.color = '#e30088';
                playBtn.style.fontSize = '1rem';
                playBtn.style.cursor = 'pointer';
                playBtn.style.marginLeft = '0.5rem';
                playBtn.style.padding = '0.3rem';
                playBtn.style.borderRadius = '50%';
                playBtn.style.transition = 'all 0.3s ease';
                playBtn.onmouseover = () => playBtn.style.background = 'rgba(227,0,136,0.1)';
                playBtn.onmouseout = () => playBtn.style.background = 'none';
                playBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (playingIndex === idx && !audioPlayer.paused) {
                        audioPlayer.pause();
                    } else {
                        playSong(idx);
                    }
                };
                card.appendChild(playBtn);

                playlistSongsDiv.appendChild(card);
            });
            deleteBtn.style.display = 'inline-block';
        }

        function playSong(index) {
            if (index < 0 || index >= currentPlaylistSongs.length) return;

            const songTitle = currentPlaylistSongs[index];
            const songData = allSongs.find(song => song.title === songTitle);

            if (songData && songData.file) {
                if (playingIndex !== index) {
                    audioPlayer.src = songData.file;
                    audioPlayer.currentTime = 0;
                }
                audioPlayer.play();
                playingIndex = index;
                updateToggleIcon();
                renderPlaylistSongs(); // Re-render to highlight the playing song
            } else {
                alert('Audio file not found for: ' + songTitle);
            }
        }
        
        function togglePlayPause() {
            if (!currentPlaylist || currentPlaylistSongs.length === 0) return;
            if (audioPlayer.paused) {
                if (playingIndex === null) {
                    playSong(0); // Play the first song
                } else {
                    audioPlayer.play();
                }
            } else {
                audioPlayer.pause();
            }
            updateToggleIcon();
        }

        function updateToggleIcon() {
            togglePlayBtn.innerHTML = audioPlayer.paused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
        }
        
        audioPlayer.addEventListener('timeupdate', () => {
            if (!isNaN(audioPlayer.duration)) {
                progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                totalTimeEl.textContent = formatTime(audioPlayer.duration);
            }
        });

        progressBar.addEventListener('input', () => {
            if (!isNaN(audioPlayer.duration)) {
                audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
            }
        });
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return m + ':' + (s < 10 ? '0' : '') + s;
        }

        document.getElementById('next-song').onclick = () => {
            if (playingIndex !== null) {
                playSong((playingIndex + 1) % currentPlaylistSongs.length);
            }
        };

        document.getElementById('prev-song').onclick = () => {
            if (playingIndex !== null) {
                playSong((playingIndex - 1 + currentPlaylistSongs.length) % currentPlaylistSongs.length);
            }
        };

        audioPlayer.addEventListener('ended', () => document.getElementById('next-song').click());
        togglePlayBtn.onclick = togglePlayPause;
        
        deleteBtn.onclick = function() {
            const toDeleteTitles = [];
            playlistSongsDiv.querySelectorAll('.delete-checkbox:checked').forEach(cb => {
                toDeleteTitles.push(cb.dataset.songTitle);
            });
            if (toDeleteTitles.length === 0) {
                alert("Please select songs to delete.");
                return;
            }
            // Filter out the songs to be deleted
            playlists[currentPlaylist] = playlists[currentPlaylist].filter(song => !toDeleteTitles.includes(song));
            localStorage.setItem('playlists', JSON.stringify(playlists));
            playingIndex = null; // Reset player
            audioPlayer.pause();
            audioPlayer.src = '';
            renderPlaylistSongs();
            renderPlaylistButtons();
        };

        sortSelect.onchange = renderPlaylistSongs;

        // Theme toggle with localStorage sync
        // Load saved theme on page load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            const icon = themeToggleBtn.querySelector('i');
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }

        themeToggleBtn.onclick = () => {
            document.body.classList.toggle('light-theme');
            const icon = themeToggleBtn.querySelector('i');
            
            if (document.body.classList.contains('light-theme')) {
                // Switch to light theme
                localStorage.setItem('theme', 'light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            } else {
                // Switch to dark theme
                localStorage.setItem('theme', 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        };

        // Profile Dropdown
        const profileImg = document.getElementById("profile-img");
        const profileDropdown = document.getElementById("profile-dropdown");
        profileImg.addEventListener("click", (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle("show");
        });
        document.addEventListener("click", () => {
            profileDropdown.classList.remove("show");
        });
        
        // --- INITIALIZATION ---
        await loadSongsFromServer(); // First, load the song library
        renderPlaylistButtons();      // Then, render the buttons
        renderPlaylistSongs();        // Finally, render the songs for the default playlist
    });
  </script>
</body>
</html>