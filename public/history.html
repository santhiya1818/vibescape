<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Play History | VibeScape</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="vibescapelogo.jpg" type="image/jpg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Enhanced History Page Styling */
    :root {
      --bg-color: #0a0a0a;
      --text-color: #ffffff;
      --card-bg: #1a1a1a;
      --border-color: rgba(255,255,255,0.1);
      --accent: #e91e63;
      --secondary: #ff6b9d;
      --delete-color: #ff4757;
      --success-color: #2ed573;
      --gradient-1: linear-gradient(135deg, #e91e63, #ff6b9d);
      --gradient-2: linear-gradient(135deg, #667eea, #764ba2);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --history-item-bg: rgba(255, 255, 255, 0.05);
      --hover-bg: rgba(255, 255, 255, 0.1);
    }
    
    body.light-theme {
      --bg-color: #f8f9fa;
      --text-color: #2c3e50;
      --card-bg: #ffffff;
      --border-color: rgba(0,0,0,0.1);
      --accent: #e91e63;
      --secondary: #ff6b9d;
      --delete-color: #e74c3c;
      --success-color: #27ae60;
      --gradient-1: linear-gradient(135deg, #e91e63, #ff6b9d);
      --gradient-2: linear-gradient(135deg, #667eea, #764ba2);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --history-item-bg: rgba(0, 0, 0, 0.02);
      --hover-bg: rgba(0, 0, 0, 0.05);
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    
    /* Header Styling */
    header {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .logo h2 {
      background: var(--gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-weight: 600;
    }
    
    .nav-links {
      display: flex;
      gap: 25px;
    }
    
    .nav-links a {
      color: var(--text-color);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .nav-links a:hover,
    .nav-links a.active {
      background: var(--gradient-1);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
    }
    
    /* Main Content */
    main {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .history-container {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
    }
    
    .history-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .history-header h1 {
      background: var(--gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.5rem;
      margin: 0 0 10px 0;
      font-weight: 700;
    }
    
    .history-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: var(--history-item-bg);
      padding: 15px 25px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid var(--border-color);
      min-width: 120px;
    }
    
    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
      display: block;
    }
    
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.7;
      margin-top: 5px;
    }
    
    /* History List */
    #history-list {
      max-height: 600px;
      overflow-y: auto;
      border-radius: 15px;
      background: var(--history-item-bg);
      border: 1px solid var(--border-color);
    }
    
    .history-item {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .history-item:last-child {
      border-bottom: none;
    }
    
    .history-item:hover {
      background: var(--hover-bg);
      transform: translateX(5px);
    }
    
    .history-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: var(--gradient-1);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .history-item:hover::before {
      opacity: 1;
    }
    
    .song-info {
      flex: 1;
      margin-right: 15px;
    }
    
    .song-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-color);
    }
    
    .song-artist {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-bottom: 5px;
    }
    
    .play-time {
      font-size: 0.8rem;
      opacity: 0.5;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .play-time::before {
      content: 'ðŸ•’';
      font-size: 0.7rem;
    }
    
    /* Audio Player Styling */
    audio {
      background: var(--card-bg);
      border-radius: 25px;
      border: 1px solid var(--border-color);
      height: 35px;
      min-width: 200px;
    }
    
    audio::-webkit-media-controls-panel {
      background-color: var(--card-bg);
    }
    
    /* Clear History Button */
    .clear-history {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 30px auto 0;
      padding: 12px 30px;
      background: var(--gradient-2);
      border: none;
      border-radius: 25px;
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .clear-history:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .clear-history:active {
      transform: translateY(0);
    }
    
    /* Theme Toggle */
    .theme-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .theme-toggle:hover {
      background: var(--hover-bg);
      transform: rotate(180deg);
    }
    
    /* Profile Dropdown */
    .profile {
      position: relative;
    }
    
    .profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid var(--accent);
      transition: all 0.3s ease;
    }
    
    .profile img:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
    }
    
    .dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background: var(--card-bg);
      min-width: 150px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      z-index: 1000;
      overflow: hidden;
    }
    
    .dropdown a {
      color: var(--text-color);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: all 0.3s ease;
    }
    
    .dropdown a:hover {
      background: var(--hover-bg);
    }
    
    /* Footer */
    footer {
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      padding: 20px;
      text-align: center;
      margin-top: 50px;
    }
    
    footer a {
      color: var(--text-color);
      text-decoration: none;
      margin: 0 15px;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    footer a:hover {
      opacity: 1;
      color: var(--accent);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      opacity: 0.7;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    /* Scrollbar Styling */
    #history-list::-webkit-scrollbar {
      width: 8px;
    }
    
    #history-list::-webkit-scrollbar-track {
      background: var(--card-bg);
      border-radius: 4px;
    }
    
    #history-list::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
    
    #history-list::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }
      
      .history-stats {
        gap: 15px;
      }
      
      .stat-card {
        min-width: 100px;
        padding: 12px 20px;
      }
      
      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      audio {
        width: 100%;
        min-width: auto;
      }
    }

    /* Hero Section Styles */
    .hero-section {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      padding: 80px 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-bottom: 40px;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.1"><path d="M30 30c0-11.046-8.954-20-20-20s-20 8.954-20 20 8.954 20 20 20 20-8.954 20-20zm0 0c0 11.046 8.954 20 20 20s20-8.954 20-20-8.954-20-20-20-20 8.954-20 20z"/></g></g></svg>') repeat;
      opacity: 0.3;
    }

    .hero-content {
      position: relative;
      z-index: 2;
      max-width: 600px;
      margin: 0 auto;
    }

    .hero-icon {
      font-size: 4rem;
      color: var(--text);
      margin-bottom: 20px;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .hero-subtitle {
      font-size: 1.2rem;
      color: var(--text);
      opacity: 0.9;
      margin-top: 15px;
      line-height: 1.6;
    }

    /* History Container */
    .history-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* History Header */
    .history-header {
      background: var(--card);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    /* Statistics Cards */
    .history-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text);
      padding: 20px 25px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.6s ease;
    }

    .stat-card:hover::before {
      left: 100%;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.25);
    }

    .stat-card i {
      font-size: 2rem;
      opacity: 0.9;
    }

    .stat-info {
      display: flex;
      flex-direction: column;
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 2px;
    }

    /* History Controls */
    .history-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box {
      position: relative;
      flex: 1;
      min-width: 250px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text);
      opacity: 0.6;
    }

    #history-search {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--input);
      color: var(--text);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    #history-search:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }

    .filter-select {
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--input);
      color: var(--text);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 140px;
    }

    .filter-select:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* History Content */
    .history-content {
      position: relative;
    }

    .history-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: var(--card);
      border-radius: 20px;
      border: 2px dashed var(--border);
    }

    .empty-illustration {
      position: relative;
      display: inline-block;
      margin-bottom: 30px;
    }

    .empty-illustration i {
      font-size: 4rem;
      color: var(--accent);
      z-index: 2;
      position: relative;
    }

    .pulse-rings {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .pulse-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      opacity: 0;
      animation: pulse-ring 2s ease-out infinite;
    }

    .pulse-ring:nth-child(2) {
      animation-delay: 0.5s;
    }

    .pulse-ring:nth-child(3) {
      animation-delay: 1s;
    }

    @keyframes pulse-ring {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1.5);
        opacity: 0;
      }
    }

    .empty-state h3 {
      color: var(--text);
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .empty-state p {
      color: var(--text);
      opacity: 0.7;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .cta-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 15px 30px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text);
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
      .hero-section {
        padding: 60px 20px;
      }
      
      .hero-icon {
        font-size: 3rem;
      }
      
      .hero-subtitle {
        font-size: 1rem;
      }
      
      .history-header {
        padding: 20px;
      }
      
      .history-stats {
        gap: 15px;
      }
      
      .stat-card {
        min-width: 100px;
        padding: 15px 20px;
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .stat-card i {
        font-size: 1.5rem;
      }
      
      .stat-number {
        font-size: 1.4rem;
      }
      
      .history-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: auto;
      }
      
      .history-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .empty-state {
        padding: 60px 20px;
      }
      
      .empty-illustration i {
        font-size: 3rem;
      }
    }

    @media (max-width: 480px) {
      .stat-card {
        min-width: auto;
        padding: 12px 15px;
      }
      
      .hero-section {
        padding: 40px 15px;
      }
      
      .history-container {
        padding: 0 15px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="vibescapelogo.jpg" alt="VibeScape Logo" />
      <h2>VibeScape</h2>
    </div>
    <nav class="nav-links">
      <a href="home.html">Home</a>
      <a href="history.html" class="active">History</a>
      <a href="playlist.html">Playlist</a>
      <a href="favourites.html">Favourites</a>
      <a href="comments.html">Comments</a>
    </nav>
    <button id="theme-toggle" class="theme-toggle">
      <i class="fa-solid fa-sun"></i>
    </button>
    <div class="profile" id="profile">
      <img src="https://via.placeholder.com/40" alt="Profile" id="profile-img" />
      <div class="dropdown" id="profile-dropdown">
        <a href="settings.html">Settings</a>
        <a href="index.html">Logout</a>
      </div>
    </div>
  </header>

  <main>
    <div class="hero-section">
      <div class="hero-content">
        <i class="fas fa-history hero-icon"></i>
        <h1>Your Listening Journey</h1>
        <p class="hero-subtitle">Relive your musical moments and discover your listening patterns</p>
      </div>
    </div>
    
    <div class="history-container">
      <div class="history-header">
        <div class="history-stats">
          <div class="stat-card">
            <i class="fas fa-music"></i>
            <div class="stat-info">
              <span class="stat-number" id="total-songs">0</span>
              <span class="stat-label">Songs Played</span>
            </div>
          </div>
          <div class="stat-card">
            <i class="fas fa-clock"></i>
            <div class="stat-info">
              <span class="stat-number" id="total-time">0h 0m</span>
              <span class="stat-label">Total Time</span>
            </div>
          </div>
          <div class="stat-card">
            <i class="fas fa-calendar-day"></i>
            <div class="stat-info">
              <span class="stat-number" id="today-count">0</span>
              <span class="stat-label">Today</span>
            </div>
          </div>
        </div>
        
        <div class="history-controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="history-search" placeholder="Search your history...">
          </div>
          <select id="history-filter" class="filter-select">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
          <button id="clear-history" class="clear-history" style="display:none;">
            <i class="fas fa-trash-alt"></i>
            Clear All
          </button>
        </div>
      </div>
      
      <div class="history-content">
        <div id="history-list" class="history-grid"></div>
        <div id="empty-state" class="empty-state" style="display:none;">
          <div class="empty-illustration">
            <i class="fas fa-music"></i>
            <div class="pulse-rings">
              <div class="pulse-ring"></div>
              <div class="pulse-ring"></div>
              <div class="pulse-ring"></div>
            </div>
          </div>
          <h3>No Listening History Yet</h3>
          <p>Start playing some music to see your listening history here!</p>
          <a href="home.html" class="cta-button">
            <i class="fas fa-play"></i>
            Discover Music
          </a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <a href="support.html">Support</a>
    <a href="about.html">About</a>
    <a href="terms.html">Terms of Service</a>
    <a href="privacy.html">Privacy Policy</a>
  </footer>

  <!-- *** SCRIPT SECTION HAS BEEN COMPLETELY REPLACED *** -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        let allSongs = []; // This will hold the entire song library from the server
        let history = [];

        const historyList = document.getElementById('history-list');
        const clearBtn = document.getElementById('clear-history');
        const themeToggle = document.getElementById('theme-toggle');
        const profileDiv = document.getElementById('profile');
        const profileDropdown = document.getElementById('profile-dropdown');
        
        // Get auth token for API calls
        function getAuthToken() {
            return sessionStorage.getItem('vibescape-token');
        }

        // Check if user is logged in
        function checkAuthAndRedirect() {
            const token = getAuthToken();
            if (!token) {
                alert('Please login to view your history.');
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        // Load user's history from database
        async function loadHistoryFromServer() {
            if (!checkAuthAndRedirect()) return;

            try {
                const token = getAuthToken();
                const response = await fetch('/api/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error('Failed to fetch history');
                }
                
                history = await response.json();
                console.log(`Successfully loaded ${history.length} history entries from database.`);
                renderHistory();
            } catch (error) {
                console.error("Could not load history:", error);
                historyList.innerHTML = '<p style="text-align:center; color: var(--delete-color);">Failed to load history from server.</p>';
            }
        }

        // Fetch the master song library from the server
        async function loadSongsFromServer() {
            try {
                const response = await fetch('/api/songs');
                if (!response.ok) throw new Error('Failed to fetch song library');
                allSongs = await response.json();
                console.log(`Successfully loaded ${allSongs.length} songs from the server.`);
            } catch (error) {
                console.error("Could not load song library:", error);
                historyList.innerHTML = '<p style="text-align:center; color: var(--delete-color);">Could not load song library from server.</p>';
            }
        }

        function renderHistory() {
            const historyList = document.getElementById('history-list');
            const emptyState = document.getElementById('empty-state');
            
            if (history.length === 0) {
                historyList.style.display = 'none';
                emptyState.style.display = 'block';
                clearBtn.style.display = 'none';
                updateStats();
                return;
            }

            historyList.style.display = 'grid';
            emptyState.style.display = 'none';
            clearBtn.style.display = 'inline-flex';
            
            historyList.innerHTML = '';
            
            // Apply current filter and search
            let filteredHistory = filterHistory(history);
            
            filteredHistory.forEach((historyEntry, index) => {
                const songData = allSongs.find(s => s.title === historyEntry.songTitle);

                const item = document.createElement('div');
                item.className = 'history-item';
                
                // Add animation delay for staggered effect
                item.style.animationDelay = `${index * 0.1}s`;

                const songImage = document.createElement('div');
                songImage.className = 'song-image';
                
                // Try to find song picture
                const imageName = historyEntry.songTitle.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '');
                songImage.innerHTML = `
                    <img src="songpic/${imageName}.jpg" alt="${historyEntry.songTitle}" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="default-image" style="display:none;">
                        <i class="fas fa-music"></i>
                    </div>
                `;

                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';

                const songHeader = document.createElement('div');
                songHeader.className = 'song-header';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'song-title';
                titleDiv.textContent = historyEntry.songTitle;

                const playButton = document.createElement('button');
                playButton.className = 'play-btn';
                playButton.innerHTML = '<i class="fas fa-play"></i>';
                
                if (songData) {
                    playButton.onclick = (e) => {
                        e.stopPropagation();
                        const audio = item.querySelector('audio');
                        if (audio.paused) {
                            // Pause all other audio elements
                            document.querySelectorAll('audio').forEach(a => a.pause());
                            audio.play();
                            playButton.innerHTML = '<i class="fas fa-pause"></i>';
                        } else {
                            audio.pause();
                            playButton.innerHTML = '<i class="fas fa-play"></i>';
                        }
                    };
                } else {
                    playButton.disabled = true;
                    playButton.style.opacity = '0.5';
                    playButton.innerHTML = '<i class="fas fa-ban"></i>';
                }

                songHeader.appendChild(titleDiv);
                songHeader.appendChild(playButton);

                const artistDiv = document.createElement('div');
                artistDiv.className = 'song-artist';
                artistDiv.textContent = historyEntry.artist;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'play-time';
                const playedDate = new Date(historyEntry.playedAt);
                timeDiv.innerHTML = `
                    <i class="fas fa-clock"></i>
                    <span>${formatRelativeTime(playedDate)}</span>
                    <small>${playedDate.toLocaleDateString()}</small>
                `;

                songInfo.appendChild(songHeader);
                songInfo.appendChild(artistDiv);
                songInfo.appendChild(timeDiv);

                const songActions = document.createElement('div');
                songActions.className = 'song-actions';

                if (songData) {
                    const audio = document.createElement('audio');
                    audio.src = songData.file;
                    audio.preload = 'metadata';
                    
                    // Update play button when audio ends
                    audio.onended = () => {
                        playButton.innerHTML = '<i class="fas fa-play"></i>';
                    };
                    
                    // Update play button when audio is paused
                    audio.onpause = () => {
                        playButton.innerHTML = '<i class="fas fa-play"></i>';
                    };
                    
                    // Update play button when audio starts playing
                    audio.onplay = () => {
                        playButton.innerHTML = '<i class="fas fa-pause"></i>';
                    };
                    
                    songActions.appendChild(audio);
                } else {
                    const unavailableMsg = document.createElement('div');
                    unavailableMsg.className = 'unavailable-msg';
                    unavailableMsg.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Song no longer available';
                    songActions.appendChild(unavailableMsg);
                    item.classList.add('unavailable');
                }

                // Add favorite button
                const favoriteBtn = document.createElement('button');
                favoriteBtn.className = 'favorite-btn';
                favoriteBtn.innerHTML = '<i class="far fa-heart"></i>';
                favoriteBtn.title = 'Add to Favorites';
                // You can implement favorite functionality here
                
                songActions.appendChild(favoriteBtn);

                item.appendChild(songImage);
                item.appendChild(songInfo);
                item.appendChild(songActions);
                historyList.appendChild(item);
            });

            updateStats();
        }

        function updateStats() {
            const totalSongs = document.getElementById('total-songs');
            const totalTime = document.getElementById('total-time');
            const todayCount = document.getElementById('today-count');
            
            // Calculate statistics
            const total = history.length;
            const today = new Date();
            const todayHistory = history.filter(entry => {
                const entryDate = new Date(entry.playedAt);
                return entryDate.toDateString() === today.toDateString();
            });
            
            // Estimate total time (assuming average 3.5 minutes per song)
            const estimatedMinutes = total * 3.5;
            const hours = Math.floor(estimatedMinutes / 60);
            const minutes = Math.floor(estimatedMinutes % 60);
            
            totalSongs.textContent = total;
            totalTime.textContent = `${hours}h ${minutes}m`;
            todayCount.textContent = todayHistory.length;
        }

        function filterHistory(historyArray) {
            const filter = document.getElementById('history-filter').value;
            const searchTerm = document.getElementById('history-search').value.toLowerCase();
            
            let filtered = historyArray;
            
            // Apply time filter
            if (filter !== 'all') {
                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const startOfWeek = new Date(startOfToday.getTime() - (7 * 24 * 60 * 60 * 1000));
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                filtered = historyArray.filter(entry => {
                    const entryDate = new Date(entry.playedAt);
                    switch(filter) {
                        case 'today':
                            return entryDate >= startOfToday;
                        case 'week':
                            return entryDate >= startOfWeek;
                        case 'month':
                            return entryDate >= startOfMonth;
                        default:
                            return true;
                    }
                });
            }
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(entry => 
                    entry.songTitle.toLowerCase().includes(searchTerm) ||
                    entry.artist.toLowerCase().includes(searchTerm)
                );
            }
            
            return filtered;
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        // Add event listeners for search and filter
        document.getElementById('history-search').addEventListener('input', renderHistory);
        document.getElementById('history-filter').addEventListener('change', renderHistory);

        clearBtn.onclick = async () => {
            if (confirm('Are you sure you want to clear your entire listening history?')) {
                try {
                    const token = sessionStorage.getItem('token');
                    const response = await fetch('/api/history', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        history = [];
                        renderHistory();
                    } else {
                        console.error('Failed to clear history:', await response.text());
                        alert('Failed to clear history. Please try again.');
                    }
                } catch (error) {
                    console.error('Error clearing history:', error);
                    alert('An error occurred while clearing history.');
                }
            }
        };

        // --- Standard UI Elements ---
        // Load saved theme on page load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            const icon = themeToggle.querySelector('i');
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }

        themeToggle.onclick = () => {
            document.body.classList.toggle('light-theme');
            const icon = themeToggle.querySelector('i');
            
            if (document.body.classList.contains('light-theme')) {
                // Switch to light theme
                localStorage.setItem('theme', 'light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            } else {
                // Switch to dark theme
                localStorage.setItem('theme', 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        };

        profileDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', () => {
            profileDropdown.style.display = 'none';
        });

        // --- INITIALIZATION ---
        await loadSongsFromServer(); // First, load the master song library
        await loadHistoryFromServer(); // Then, load the user's history from database
    });
  </script>
</body>
</html>